(function(){
  'use strict'

  angular.module('treeApp', ['ngAnimate'])
    .config(function($interpolateProvider) {
      $interpolateProvider.startSymbol('{[');
      $interpolateProvider.endSymbol(']}');
    });
})();

(function(){
  'use strict';

  angular.module('treeApp')
    .controller('TopicTreeController', TopicTreeController);

  TopicTreeController.$inject = ['TopicApi', 'PulpService'];

  function TopicTreeController(TopicApi, PulpService){
    var vm = this;

    var chosenTopicsCount = 0;
    var chosenTopics = [];

    vm.expanded = true;
    vm.topicDisplayLimit = 20;
    vm.toggleChooseTopic = toggleChooseTopic;
    vm.toggleActivateTopic = toggleActivateTopic;
    vm.toggleExpandTopic = toggleExpandTopic;
    vm.loadMoreTopics = loadMoreTopics;
    vm.startSearch = startSearch;

    TopicApi.getTopics()
      .then(function(topics){
        vm.topics = topics;
      });

    function toggleChooseTopic(topic) {
      topic.chosen = !topic.chosen;

      if (topic.chosen) {
        chosenTopicsCount++;
        chosenTopics.push(topic);
      } else {
        chosenTopicsCount--;
        removeFromChosenTopics(topic);
      }

      vm.topicIsChosen = ( chosenTopicsCount > 0 );
    }

    function toggleActivateTopic(topic) {
      if (!topic.activated) {
        vm.topics.forEach(function(topic) {
          topic.activated = false
        });
      }

      topic.activated = !topic.activated;

      if (topic.activated) {
        vm.activeTopic = topic;
        vm.expanded = false;
      } else {
        vm.expanded = true;
        vm.activeTopic = null;
      }
    }

    function loadMoreTopics() {
      vm.topicDisplayLimit += 20;
    }

    function toggleExpandTopic(topic) {
      topic.expanded = !topic.expanded;
    }

    function startSearch(){
      var chosenTopicsToStr = _.chain(chosenTopics).map(function(t) { return t.title }).uniq().join(' ').split(' ').uniq().value().join('+');

      PulpService.toPulp({ query: chosenTopicsToStr });
    }

    function removeFromChosenTopics(topic) {
      var removedIndex = 0;

      chosenTopics.forEach(function(t, index) {
        if (t.title == topic.title) {
          removedIndex = index;
        }
      });

      chosenTopics.splice(removedIndex, 1);
    }
  }
})();

(function(){
  'use strict';

  angular.module('treeApp')
    .factory('PulpService', PulpService);

  PulpService.$inject = ['$window'];

  function PulpService($window){
    var PULP_URL = 'http://localhost:8000';

    var service = {
      toPulp: toPulp
    }

    function toPulp(options){
      $window.open(PULP_URL + '/search#/?query=' + options.query, '_blank');
    }

    return service;
  }
})();

(function(){
  'use strict';

  angular.module('treeApp')
    .factory('TopicApi', TopicApi);

  TopicApi.$inject = ['$http', '$q'];

  function TopicApi($http, $q){
    var service = {
      getTopics: getTopics
    }

    function getTopics(){
      var deferred = $q.defer();

      var topics = [];

      _.times(40, function(){
        topics.push({ title: 'Lorem ipsum dolor sit amet '});
      });

      topics.forEach(function(topic){
        topic.children = [];

        _.times(20, function(){
          topic.children.push({ title: 'Lorem ipsum dolor sit amet '});
        });

        topic.children.forEach(function(child){
          child.children = [];

          _.times(10, function(){
            child.children.push({ title: 'Lorem ipsum dolor sit amet '});
          });
        });
      });

      deferred.resolve(topics);

      return deferred.promise;
    }

    return service;
  }
})();
